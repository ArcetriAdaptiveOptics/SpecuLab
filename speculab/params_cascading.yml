---

main:
  class:             'SimulParams'
  root_dir:          './calib/cascading'         # Root directory for calibration manager  
  pixel_pupil:       120                    # Linear dimension of pupil phase array
  pixel_pitch:       0.05                   # [m] Pitch of the pupil phase array
  total_time:        1.640                  # [s] Total simulation running time
  time_step:         0.001                  # [s] Simulation time step
  add_modules:       ['speculab']


#server:
#  class:             'DisplayServer'
#  host:              '0.0.0.0'              # Listen on all interfaces
#  port:              3000                   # Use zero for auto-selection


seeing:
  class:             'WaveGenerator'
  constant:          0.8                   # ["] seeing value
  outputs: ['output']


wind_speed:
  class:             'WaveGenerator'
  constant:          [20.]                #,10.,20.,10.]      # [m/s] Wind speed value
  outputs: ['output']


wind_direction:
  class:             'WaveGenerator'
  constant:          [0.] #,270.,270.,90.]   # [degrees] Wind direction value
  outputs: ['output']


on_axis_source:
  class:             'Source'
  polar_coordinates:  [0.0, 0.0]           # [arcsec, degrees] source polar coordinates
  magnitude:         8                    # source magnitude
  wavelengthInNm:    750                   # [nm] wavelength


pupilstop:                                 # Default parameters (circular pupil)
  class: 'Pupilstop'
  simul_params_ref: 'main'


atmo:
  class:                'AtmoEvolution'
  simul_params_ref:     'main'
  L0:                   40                   # [m] Outer scale
  heights:              [119.] #,837,3045,12780]), # [m] layer heights at 0 zenith angle
  Cn2:                  [1.00] #,0.06,0.14,0.10]), # Cn2 weights (total must be eq 1)
  fov:                  0.0
  inputs:
    seeing: 'seeing.output'
    wind_speed: 'wind_speed.output'
    wind_direction: 'wind_direction.output'
  outputs: ['layer_list']


prop:
  class:                'AtmoPropagation'
  simul_params_ref:     'main'
  source_dict_ref:      ['on_axis_source']
  inputs:
    atmo_layer_list: ['atmo.layer_list']
    common_layer_list: ['pupilstop',
                        'dm.out_layer:-1']
  outputs: ['out_on_axis_source_ef']

ifunc_alpao820:
  class:             'IFunc'
  ifunc_data:        'alpao820_zonal_im'
  mask_data:         'alpao820_mask_ones'

ifunc_inv_alpao820:
  class:             'IFuncInv'
  ifunc_inv_data:    'alpao820_zonal_im_inverted'
  mask_data:         'alpao820_mask_ones'

m2c_alpao820:
  class:             'M2C'
  m2c_data:          'alpao820_m2c'

alpao820dm:
  class:             'PlicoDM'
  host:              'localhost'
  port:              7010
  ifunc_inv_ref:    'ifunc_inv_alpao820' 
  inputs:
      in_ef: 'prop.out_on_axis_source_ef'
  outputs: ['out_trigger']

detector:
  class:             'PysilicoCamera'
  host:              'localhost'
  port:               7101
  roi_topleft_xy:     [706, 682]
  roi_bottomright_xy: [2290, 2310]
  inputs:
    in_trigger: ['alpao820dm.out_trigger']
  outputs: ['out_pixels']


slopec:
  class:             'ShSlopec'  
  subapdata_object:  'cascading_subaps'       # tag of the pyramid WFS pupils
  sn_object:         null
  inputs:
    in_pixels:       'detector.out_pixels'
  outputs: ['out_slopes']

rec:
  class:              'Modalrec'  
  recmat_object:      'cascading_rec'         # reconstruction matrix tag
  inputs:
    in_slopes:        'slopec.out_slopes'
  outputs: ['out_modes']

control:
  class:             'Integrator'
  simul_params_ref:  'main'
  delay:             2                      # Total temporal delay in time steps
  int_gain:          [0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5, # Integrator gain (for 'INT' control)
                      0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,
                      0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,
                      0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,
                      0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,
                      0.5,0.5,0.5,0.5]  
  inputs:
      delta_comm: 'rec.out_modes'
  ouputs: ['out_comm']

dm:
  class:             'DM'
  simul_params_ref:  'main'
  m2c_ref:           'm2c_alpao820'
  ifunc_ref:         'ifunc_alpao820'
  nmodes:            820                   # number of modes
  height:            0                     # DM height [m]
  inputs:
      in_command: 'control.out_comm'
  outputs: ['out_layer']


psf:
  class:             'PSF'
  simul_params_ref:  'main'
  wavelengthInNm:    1650                 # [nm] Imaging wavelength
  nd:                8                    # padding coefficient for PSF computation
  start_time:        0.05                # PSF integration start time
  inputs:
      in_ef:  'prop.out_on_axis_source_ef'


data_store:
  class:             'DataStore'
  split_size:        40
  first_suffix:      0
  store_dir:         './output'             # Data result directory: 'store_dir'/TN/
  inputs:    
    input_list: [ 'res_ef-prop.out_on_axis_source_ef',
                  'control-control.out_comm'
                   ]

pixels_disp:
  class:             'PixelsDisplay'
  inputs:
    pixels: 'detector.out_pixels'
  title:   'Pixels Display'
  figsize: [10, 10]

slopec_disp:
  class:             'SlopecDisplay'
  inputs:
    slopes: 'slopec.out_slopes'
  figsize: [8, 6]

